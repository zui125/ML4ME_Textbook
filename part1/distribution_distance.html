<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mark Fuge">
<meta name="dcterms.date" content="2025-10-20">

<title>6&nbsp; Measuring Distribution Distances – Machine Learning for Mechanical Engineering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../part2/part2.html" rel="next">
<link href="../part1/taking_derivatives.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-3584025bd2775ba93d20b6dabf7256d8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../part1/part1.html">Foundational Skills</a></li><li class="breadcrumb-item"><a href="../part1/distribution_distance.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Measuring Distribution Distances</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Machine Learning for Mechanical Engineering</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../part1/part1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundational Skills</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part1/reviewing_supervised_linear_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Reviewing Supervised Linear Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/cross_validation_linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Evaluating Machine Learning Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/supervised_linear_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to Gradient Descent</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part1/linear_decompositions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Review of Linear Unsupervised Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part1/taking_derivatives.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Taking Derivatives with Automatic Differentiation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part1/distribution_distance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Measuring Distribution Distances</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../part2/part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model-Specific Approaches</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part2/review_neural_networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Review of Neural Networks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part2/gen_models/intro_to_GANS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction to Push-Forward Generative Models – Generative Adversarial Networks (GANs)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part2/gen_models/GAN_pitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">GAN Training Pitfalls</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../part2/gen_models/OT.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Optimal Transport for Generative Models</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../problems/problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../problems/ps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Problem Set 1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../notebooks/notebooks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">In-Class Notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/california_housing_visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Housing Price Data Visualization In-Class Exercise</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/helpful_tooling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Helpful Tooling for Working with and Debugging Machine Learning Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/course_progression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Course Lecture Progression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/review_of_singular_value_decomposition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Review of Matrices and the Singular Value Decomposition</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-toy-example-comparing-two-gaussians" id="toc-a-toy-example-comparing-two-gaussians" class="nav-link active" data-scroll-target="#a-toy-example-comparing-two-gaussians"><span class="header-section-number">6.1</span> A Toy Example: Comparing Two Gaussians</a></li>
  <li><a href="#kullbackleibler-divergence" id="toc-kullbackleibler-divergence" class="nav-link" data-scroll-target="#kullbackleibler-divergence"><span class="header-section-number">6.2</span> Kullback–Leibler Divergence</a>
  <ul class="collapse">
  <li><a href="#analytical-gradient-for-gaussian-vs.-gaussian" id="toc-analytical-gradient-for-gaussian-vs.-gaussian" class="nav-link" data-scroll-target="#analytical-gradient-for-gaussian-vs.-gaussian"><span class="header-section-number">6.2.1</span> Analytical Gradient for Gaussian vs.&nbsp;Gaussian</a></li>
  <li><a href="#forward-vs.-reverse-kl-on-a-bimodal-target" id="toc-forward-vs.-reverse-kl-on-a-bimodal-target" class="nav-link" data-scroll-target="#forward-vs.-reverse-kl-on-a-bimodal-target"><span class="header-section-number">6.2.2</span> Forward vs.&nbsp;Reverse KL on a Bimodal Target</a></li>
  </ul></li>
  <li><a href="#jensenshannon-divergence" id="toc-jensenshannon-divergence" class="nav-link" data-scroll-target="#jensenshannon-divergence"><span class="header-section-number">6.3</span> Jensen–Shannon Divergence</a>
  <ul class="collapse">
  <li><a href="#mathematical-formulation" id="toc-mathematical-formulation" class="nav-link" data-scroll-target="#mathematical-formulation"><span class="header-section-number">6.3.1</span> Mathematical Formulation</a></li>
  </ul></li>
  <li><a href="#maximum-mean-discrepancy-mmd" id="toc-maximum-mean-discrepancy-mmd" class="nav-link" data-scroll-target="#maximum-mean-discrepancy-mmd"><span class="header-section-number">6.4</span> Maximum Mean Discrepancy (MMD)</a></li>
  <li><a href="#optimal-transport-wasserstein-2-distance" id="toc-optimal-transport-wasserstein-2-distance" class="nav-link" data-scroll-target="#optimal-transport-wasserstein-2-distance"><span class="header-section-number">6.5</span> Optimal Transport (Wasserstein-2 Distance)</a></li>
  <li><a href="#information-geometry-vs.-optimal-transport" id="toc-information-geometry-vs.-optimal-transport" class="nav-link" data-scroll-target="#information-geometry-vs.-optimal-transport"><span class="header-section-number">6.6</span> Information Geometry vs.&nbsp;Optimal Transport</a></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up"><span class="header-section-number">6.7</span> Wrap-Up</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../part1/part1.html">Foundational Skills</a></li><li class="breadcrumb-item"><a href="../part1/distribution_distance.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Measuring Distribution Distances</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Measuring Distribution Distances</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mark Fuge </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 20, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This notebook explores several ways of quantifying distances between one-dimensional probability distributions. We will contrast their mathematical definitions, visualize how they react to parameter changes, and compare the gradients that each metric produces. The goal is to build intuition for why the choice of divergence matters in optimization problems such as generative modeling or system identification. We will explore the following:</p>
<ul>
<li>Contrast forward KL, reverse KL, Jensen–Shannon divergence, Maximum Mean Discrepancy, Wasserstein distance, and Fisher–Rao metrics on simple families of distributions.</li>
<li>Inspect how each distance responds to shifting the mean of a model Gaussian relative to a fixed target distribution.</li>
<li>Visualize analytical or automatic-differentiation gradients to anticipate their effect on parameter updates.</li>
<li>Experiment interactively with key hyperparameters (e.g., kernel bandwidth, mixture weights) to see how diagnostics change.</li>
</ul>
<div id="3e77908e" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup and shared imports</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable, Dict, Tuple</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.gridspec <span class="im">import</span> GridSpec</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    sns.set_context(<span class="st">"talk"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    sns <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> ipywidgets <span class="im">as</span> widgets</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    widgets <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    display <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure reproducibility for sampling-based diagnostics</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(<span class="dv">42</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>DEFAULT_DTYPE <span class="op">=</span> torch.float64</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c0905160" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Shared Distribution Utilities</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We will represent each distribution by two callables:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - `pdf(x)` returning the probability density evaluated on a 1D tensor `x`.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - `sample(n, base_noise)` producing differentiable samples (re-using base noise when we need gradients).</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># To keep gradients tractable, we lean on reparameterizations for Gaussians and deterministic mixtures of Gaussians. For numerical integrals we discretize the domain on a dense grid.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Dense grid for numerical integration and visualization</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>GRID_X <span class="op">=</span> torch.linspace(<span class="op">-</span><span class="fl">6.0</span>, <span class="fl">6.0</span>, <span class="dv">2048</span>, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>DX <span class="op">=</span> GRID_X[<span class="dv">1</span>] <span class="op">-</span> GRID_X[<span class="dv">0</span>]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>EPS <span class="op">=</span> torch.tensor(<span class="fl">1e-12</span>, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian_pdf_torch(x: torch.Tensor, mean: torch.Tensor <span class="op">|</span> <span class="bu">float</span>, std: torch.Tensor <span class="op">|</span> <span class="bu">float</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Evaluate the Gaussian pdf on `x` using broadcasted parameters."""</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    mean_t <span class="op">=</span> torch.as_tensor(mean, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    std_t <span class="op">=</span> torch.as_tensor(std, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> std_t <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    norm_const <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> torch.sqrt(<span class="fl">2.0</span> <span class="op">*</span> math.pi <span class="op">*</span> var)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> (x <span class="op">-</span> mean_t) <span class="op">**</span> <span class="dv">2</span> <span class="op">/</span> (<span class="fl">2.0</span> <span class="op">*</span> var)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> norm_const <span class="op">*</span> torch.exp(<span class="op">-</span>z)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> uniform_pdf_torch(x: torch.Tensor, low: <span class="bu">float</span>, high: <span class="bu">float</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    low_t <span class="op">=</span> torch.as_tensor(low, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    high_t <span class="op">=</span> torch.as_tensor(high, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    inside <span class="op">=</span> (x <span class="op">&gt;=</span> low_t) <span class="op">&amp;</span> (x <span class="op">&lt;=</span> high_t)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inside.to(DEFAULT_DTYPE) <span class="op">/</span> (high_t <span class="op">-</span> low_t <span class="op">+</span> EPS)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian_mixture_pdf_torch(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    x: torch.Tensor,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    means: torch.Tensor,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    stds: torch.Tensor,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    weights: torch.Tensor,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    comps <span class="op">=</span> [w <span class="op">*</span> gaussian_pdf_torch(x, m, s) <span class="cf">for</span> w, m, s <span class="kw">in</span> <span class="bu">zip</span>(weights, means, stds)]</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.stack(comps, dim<span class="op">=</span><span class="dv">0</span>).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DistributionSpec:</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    pdf: Callable[[torch.Tensor], torch.Tensor]</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    sampler: Callable[[<span class="bu">int</span>, torch.Tensor <span class="op">|</span> <span class="va">None</span>], torch.Tensor]</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    metadata: Dict[<span class="bu">str</span>, <span class="bu">float</span>]</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_gaussian(mean: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0</span>, std: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>) <span class="op">-&gt;</span> DistributionSpec:</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    mean_t <span class="op">=</span> torch.tensor(mean, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    std_t <span class="op">=</span> torch.tensor(std, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _pdf(x: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gaussian_pdf_torch(x, mean_t, std_t)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _sample(n: <span class="bu">int</span>, base_noise: torch.Tensor <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        eps <span class="op">=</span> torch.randn(n, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device) <span class="cf">if</span> base_noise <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> base_noise</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_t <span class="op">+</span> std_t <span class="op">*</span> eps</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    meta <span class="op">=</span> {<span class="st">"mean"</span>: <span class="bu">float</span>(mean), <span class="st">"std"</span>: <span class="bu">float</span>(std)}</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> DistributionSpec(name<span class="op">=</span><span class="ss">f"Gaussian(μ=</span><span class="sc">{</span>mean<span class="sc">:.2f}</span><span class="ss">, σ=</span><span class="sc">{</span>std<span class="sc">:.2f}</span><span class="ss">)"</span>, pdf<span class="op">=</span>_pdf, sampler<span class="op">=</span>_sample, metadata<span class="op">=</span>meta)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_uniform(low: <span class="bu">float</span> <span class="op">=</span> <span class="op">-</span><span class="fl">2.0</span>, high: <span class="bu">float</span> <span class="op">=</span> <span class="fl">2.0</span>) <span class="op">-&gt;</span> DistributionSpec:</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    low_t <span class="op">=</span> torch.tensor(low, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    high_t <span class="op">=</span> torch.tensor(high, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _pdf(x: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> uniform_pdf_torch(x, <span class="bu">float</span>(low_t), <span class="bu">float</span>(high_t))</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _sample(n: <span class="bu">int</span>, base_noise: torch.Tensor <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> base_noise <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>            base_noise <span class="op">=</span> torch.rand(n, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> low_t <span class="op">+</span> (high_t <span class="op">-</span> low_t) <span class="op">*</span> base_noise</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    meta <span class="op">=</span> {<span class="st">"low"</span>: <span class="bu">float</span>(low), <span class="st">"high"</span>: <span class="bu">float</span>(high)}</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> DistributionSpec(name<span class="op">=</span><span class="ss">f"Uniform[</span><span class="sc">{</span>low<span class="sc">:.1f}</span><span class="ss">, </span><span class="sc">{</span>high<span class="sc">:.1f}</span><span class="ss">]"</span>, pdf<span class="op">=</span>_pdf, sampler<span class="op">=</span>_sample, metadata<span class="op">=</span>meta)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_gaussian_mixture(</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    means: Tuple[<span class="bu">float</span>, <span class="bu">float</span>] <span class="op">=</span> (<span class="op">-</span><span class="fl">2.0</span>, <span class="fl">2.0</span>),</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    stds: Tuple[<span class="bu">float</span>, <span class="bu">float</span>] <span class="op">=</span> (<span class="fl">0.6</span>, <span class="fl">0.6</span>),</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    weights: Tuple[<span class="bu">float</span>, <span class="bu">float</span>] <span class="op">=</span> (<span class="fl">0.5</span>, <span class="fl">0.5</span>),</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> DistributionSpec:</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    means_t <span class="op">=</span> torch.tensor(means, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    stds_t <span class="op">=</span> torch.tensor(stds, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    weights_t <span class="op">=</span> torch.tensor(weights, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    weights_t <span class="op">=</span> weights_t <span class="op">/</span> weights_t.<span class="bu">sum</span>()</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _pdf(x: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gaussian_mixture_pdf_torch(x, means_t, stds_t, weights_t)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _sample(n: <span class="bu">int</span>, base_noise: torch.Tensor <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> base_noise <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>            base_noise <span class="op">=</span> torch.rand(n, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>        cumulative <span class="op">=</span> torch.cumsum(weights_t, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>        choices <span class="op">=</span> torch.bucketize(base_noise, cumulative)</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>        eps <span class="op">=</span> torch.randn(n, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>        samples <span class="op">=</span> torch.empty(n, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, (m, s) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(means_t, stds_t)):</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> choices <span class="op">==</span> idx</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>                samples[mask] <span class="op">=</span> m <span class="op">+</span> s <span class="op">*</span> eps[mask]</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> samples</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    meta <span class="op">=</span> {</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"means"</span>: <span class="bu">tuple</span>(<span class="bu">float</span>(m) <span class="cf">for</span> m <span class="kw">in</span> means),</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"stds"</span>: <span class="bu">tuple</span>(<span class="bu">float</span>(s) <span class="cf">for</span> s <span class="kw">in</span> stds),</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weights"</span>: <span class="bu">tuple</span>(<span class="bu">float</span>(w) <span class="cf">for</span> w <span class="kw">in</span> weights),</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    desc <span class="op">=</span> <span class="st">", "</span>.join([<span class="ss">f"μ=</span><span class="sc">{</span>m<span class="sc">:.1f}</span><span class="ss">"</span> <span class="cf">for</span> m <span class="kw">in</span> means])</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> DistributionSpec(name<span class="op">=</span><span class="ss">f"Gaussian Mixture (</span><span class="sc">{</span>desc<span class="sc">}</span><span class="ss">)"</span>, pdf<span class="op">=</span>_pdf, sampler<span class="op">=</span>_sample, metadata<span class="op">=</span>meta)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="9b05007e" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Common plotting helpers</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({<span class="st">"figure.figsize"</span>: (<span class="dv">10</span>, <span class="dv">5</span>), <span class="st">"axes.grid"</span>: <span class="va">True</span>})</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_distribution_pair(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    grid: torch.Tensor,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    target_pdf: torch.Tensor,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    model_pdf: torch.Tensor,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    title: <span class="bu">str</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    target_label: <span class="bu">str</span> <span class="op">=</span> <span class="st">"Target"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    model_label: <span class="bu">str</span> <span class="op">=</span> <span class="st">"Model"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    ax.plot(grid.cpu().numpy(), target_pdf.cpu().numpy(), label<span class="op">=</span>target_label, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(grid.cpu().numpy(), model_pdf.cpu().numpy(), label<span class="op">=</span>model_label, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_metric_and_gradient(</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    mu_values: np.ndarray,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    metric_values: np.ndarray,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    gradient_values: np.ndarray,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    metric_name: <span class="bu">str</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    target_desc: <span class="bu">str</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> GridSpec(<span class="dv">1</span>, <span class="dv">2</span>, figure<span class="op">=</span>fig)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    ax_metric <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    ax_grad <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    ax_metric.plot(mu_values, metric_values, color<span class="op">=</span><span class="st">"tab:blue"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    ax_metric.set_title(<span class="ss">f"</span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss"> vs. μ"</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    ax_metric.set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    ax_metric.set_ylabel(metric_name)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    ax_grad.plot(mu_values, gradient_values, color<span class="op">=</span><span class="st">"tab:red"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    ax_grad.axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    ax_grad.set_title(<span class="ss">f"Gradient d(</span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss">)/dμ"</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    ax_grad.set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    ax_grad.set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(<span class="ss">f"</span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss"> against </span><span class="sc">{</span>target_desc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    fig.tight_layout()</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_metric_curve(</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    mu_values: np.ndarray,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    metric_fn: Callable[[torch.Tensor], torch.Tensor],</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[np.ndarray, np.ndarray]:</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> []</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    grads <span class="op">=</span> []</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> mu <span class="kw">in</span> mu_values:</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        mu_t <span class="op">=</span> torch.tensor(mu, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device, requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        metric <span class="op">=</span> metric_fn(mu_t)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        grad <span class="op">=</span> torch.autograd.grad(metric, mu_t)[<span class="dv">0</span>]</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        metrics.append(metric.detach().cpu().item())</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>        grads.append(grad.detach().cpu().item())</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(metrics), np.array(grads)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maybe_display(widget: widgets.Widget <span class="op">|</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> widget <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ipywidgets not available in this environment. Install ipywidgets to enable interactivity."</span>)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        display(widget)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="eadda04c" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define canonical target distributions used throughout the notebook</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>TARGETS: Dict[<span class="bu">str</span>, DistributionSpec] <span class="op">=</span> {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gaussian"</span>: make_gaussian(mean<span class="op">=</span><span class="fl">0.0</span>, std<span class="op">=</span><span class="fl">1.0</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wide_gaussian"</span>: make_gaussian(mean<span class="op">=</span><span class="fl">0.0</span>, std<span class="op">=</span><span class="fl">1.8</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"uniform"</span>: make_uniform(low<span class="op">=-</span><span class="fl">3.0</span>, high<span class="op">=</span><span class="fl">3.0</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gaussian_mixture"</span>: make_gaussian_mixture(means<span class="op">=</span>(<span class="op">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span>), stds<span class="op">=</span>(<span class="fl">0.6</span>, <span class="fl">0.6</span>), weights<span class="op">=</span>(<span class="fl">0.35</span>, <span class="fl">0.65</span>)),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#TARGETS</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="a-toy-example-comparing-two-gaussians" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="a-toy-example-comparing-two-gaussians"><span class="header-section-number">6.1</span> A Toy Example: Comparing Two Gaussians</h2>
<p>We will compare a <em>target</em> distribution <span class="math inline">\(p(x)\)</span> against a <em>model</em> distribution <span class="math inline">\(q_\mu(x)\)</span> whose mean <span class="math inline">\(\mu\)</span> we can adjust. Unless stated otherwise, the target will be the standard normal distribution. You can change that later to a uniform or a bimodal mixture to reveal different behaviours.</p>
<p>Our baseline parameterization keeps the model standard deviation fixed at <span class="math inline">\(\sigma_q = 1\)</span>. Adjusting the mean already highlights how asymmetric divergences produce different gradient signals.</p>
<div id="92e3551c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline visualization: standard normal target vs. shifted model Gaussian</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>TARGET <span class="op">=</span> TARGETS[<span class="st">"gaussian"</span>]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>MODEL_STD <span class="op">=</span> torch.tensor(<span class="fl">1.0</span>, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>MU_BASE <span class="op">=</span> torch.tensor(<span class="fl">1.5</span>, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    target_pdf <span class="op">=</span> TARGET.pdf(GRID_X)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    model_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, MU_BASE, MODEL_STD)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>plot_distribution_pair(GRID_X, target_pdf, model_pdf, title<span class="op">=</span><span class="st">"Baseline Comparison"</span>, target_label<span class="op">=</span>TARGET.name, model_label<span class="op">=</span><span class="ss">f"Gaussian(μ=</span><span class="sc">{</span>MU_BASE<span class="sc">.</span>item()<span class="sc">:.1f}</span><span class="ss">, σ=1.0)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="kullbackleibler-divergence" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="kullbackleibler-divergence"><span class="header-section-number">6.2</span> Kullback–Leibler Divergence</h2>
<p>Forward KL divergence compares how much mass the target distribution assigns relative to the model: <span class="math display">\[
\mathrm{KL}(p\,\|\,q) = \int p(x) \log \frac{p(x)}{q(x)}\,dx.
\]</span> Because it integrates expectations under <span class="math inline">\(p\)</span>, it heavily penalizes situations where <span class="math inline">\(q(x)\)</span> is small while <span class="math inline">\(p(x)\)</span> is large, even if the model allocates extra mass elsewhere.</p>
<section id="analytical-gradient-for-gaussian-vs.-gaussian" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="analytical-gradient-for-gaussian-vs.-gaussian"><span class="header-section-number">6.2.1</span> Analytical Gradient for Gaussian vs.&nbsp;Gaussian</h3>
<p>For <span class="math inline">\(p = \mathcal{N}(\mu_p, \sigma_p^2)\)</span> and <span class="math inline">\(q = \mathcal{N}(\mu, \sigma_q^2)\)</span>, forward KL admits a closed form: <span class="math display">\[
\mathrm{KL}(p\,\|\,q) = \log \frac{\sigma_q}{\sigma_p} + \frac{\sigma_p^2 + (\mu_p - \mu)^2}{2\sigma_q^2} - \frac{1}{2}.
\]</span> Differentiating w.r.t. the model mean gives <span class="math display">\[
\frac{\partial}{\partial \mu} \mathrm{KL}(p\,\|\,q) = \frac{\mu - \mu_p}{\sigma_q^2},
\]</span> which pushes <span class="math inline">\(\mu\)</span> directly toward <span class="math inline">\(\mu_p\)</span>. We will evaluate the integral numerically to keep the pipeline consistent when we later switch to mixtures.</p>
<div id="0d164f1b" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward and reverse KL implementations using numerical integration</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>_target_pdf_cache: Dict[<span class="bu">str</span>, torch.Tensor] <span class="op">=</span> {}</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_target_pdf(spec: DistributionSpec) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> spec.name <span class="kw">not</span> <span class="kw">in</span> _target_pdf_cache:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            _target_pdf_cache[spec.name] <span class="op">=</span> spec.pdf(GRID_X).detach()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _target_pdf_cache[spec.name]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_kl(mu: torch.Tensor, target: DistributionSpec, model_std: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    p_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    q_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu, model_std)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    integrand <span class="op">=</span> p_pdf <span class="op">*</span> torch.log((p_pdf <span class="op">+</span> EPS) <span class="op">/</span> (q_pdf <span class="op">+</span> EPS))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.trapz(integrand, GRID_X)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reverse_kl(mu: torch.Tensor, target: DistributionSpec, model_std: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    p_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    q_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu, model_std)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    integrand <span class="op">=</span> q_pdf <span class="op">*</span> torch.log((q_pdf <span class="op">+</span> EPS) <span class="op">/</span> (p_pdf <span class="op">+</span> EPS))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.trapz(integrand, GRID_X)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now let’s look at how the forward KL behaves as the model mean <span class="math inline">\(\mu\)</span> shifts away from the target mean <span class="math inline">\(\mu_p = 0\)</span>. We will plot the KL divergence, and its gradient, as we shift the model mean from -15 to 15. What do you notice about the behavior of the KL Divergence and it’s gradient?</p>
<div id="f26bdf28" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward KL distance curve for standard normal target</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">##### Change the following to see what happens #######</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>mu_values <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">15.0</span>, <span class="fl">15.0</span>, <span class="dv">121</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>model_std <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">####################################</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>forward_metrics, forward_grads <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    mu_values,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> mu: forward_kl(mu, TARGETS[<span class="st">"gaussian"</span>], model_std<span class="op">=</span>model_std),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>plot_metric_and_gradient(mu_values, forward_metrics, forward_grads, metric_name<span class="op">=</span><span class="st">"Forward KL"</span>, target_desc<span class="op">=</span>TARGETS[<span class="st">"gaussian"</span>].name)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Experiment: Forward KL on Gaussian Targets
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>What happens to both the KL Divergence and its gradient when the model mean is close to the target mean? What about when it is far away? Why is this?</li>
<li>How would the curve change if we widened the model variance? Try modifying <code>model_std</code> in the code cell above and re-running it.</li>
</ul>
</div>
</div>
<div id="b3eeb578" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive widget for forward KL</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> widgets <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    maybe_display(<span class="va">None</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    target_dropdown <span class="op">=</span> widgets.Dropdown(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>[(spec.name, key) <span class="cf">for</span> key, spec <span class="kw">in</span> TARGETS.items()],</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Target"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        style<span class="op">=</span>{<span class="st">"description_width"</span>: <span class="st">"initial"</span>},</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    mu_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">0.0</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">15.0</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">15.0</span>, step<span class="op">=</span><span class="fl">0.5</span>, description<span class="op">=</span><span class="st">"μ"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    std_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">1.0</span>, <span class="bu">min</span><span class="op">=</span><span class="fl">0.4</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">2.5</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"σ_q"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> widgets.Output()</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _update_forward_kl(<span class="op">*</span>_):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> output:</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            output.clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> TARGETS[target_dropdown.value]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            mu_val <span class="op">=</span> torch.tensor(mu_slider.value, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device, requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            std_val <span class="op">=</span> <span class="bu">float</span>(std_slider.value)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            kl_value <span class="op">=</span> forward_kl(mu_val, target, model_std<span class="op">=</span>std_val)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            grad <span class="op">=</span> torch.autograd.grad(kl_value, mu_val)[<span class="dv">0</span>].detach().cpu().item()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            target_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            model_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu_slider.value, std_val)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            mu_values <span class="op">=</span> np.linspace(mu_slider.<span class="bu">min</span>, mu_slider.<span class="bu">max</span>, <span class="dv">181</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            metrics_curve, grads_curve <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                mu_values,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> mu: forward_kl(mu, target, model_std<span class="op">=</span>std_val),</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            target_np <span class="op">=</span> target_pdf.cpu().numpy()</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            model_np <span class="op">=</span> model_pdf.cpu().numpy()</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, target_np, label<span class="op">=</span>target.name, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, model_np, label<span class="op">=</span><span class="ss">f"Model μ=</span><span class="sc">{</span>mu_slider<span class="sc">.</span>value<span class="sc">:.1f}</span><span class="ss">, σ=</span><span class="sc">{</span>std_val<span class="sc">:.1f}</span><span class="ss">"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_title(<span class="st">"Density comparison"</span>)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].legend()</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].plot(mu_values, metrics_curve, color<span class="op">=</span><span class="st">"tab:blue"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].axvline(mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].scatter([mu_slider.value], [kl_value.detach().cpu().item()], color<span class="op">=</span><span class="st">"tab:blue"</span>)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_title(<span class="st">"Forward KL vs. μ"</span>)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Forward KL"</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].plot(mu_values, grads_curve, color<span class="op">=</span><span class="st">"tab:red"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axvline(mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].scatter([mu_slider.value], [grad], color<span class="op">=</span><span class="st">"tab:red"</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_title(<span class="st">"Gradient d(KL)/dμ"</span>)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>            fig.suptitle(</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Forward KL = </span><span class="sc">{</span>kl_value<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss"> | Gradient = </span><span class="sc">{</span>grad<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">14</span>,</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>            fig.tight_layout()</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> control <span class="kw">in</span> (target_dropdown, mu_slider, std_slider):</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        control.observe(_update_forward_kl, names<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    _update_forward_kl()</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    maybe_display(widgets.VBox([widgets.HTML(<span class="st">"&lt;h4&gt;Interactive Forward KL Explorer&lt;/h4&gt;"</span>), target_dropdown, mu_slider, std_slider, output]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4439078f6a2442e1a1b9ff5b74b5ea81","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="forward-vs.-reverse-kl-on-a-bimodal-target" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="forward-vs.-reverse-kl-on-a-bimodal-target"><span class="header-section-number">6.2.2</span> Forward vs.&nbsp;Reverse KL on a Bimodal Target</h3>
<p>Reverse KL, <span class="math inline">\(\mathrm{KL}(q\,\|\,p)\)</span>, prefers to avoid regions where the model would place mass but the target does not. On multimodal targets this often leads to <em>mode seeking</em>: the optimizer chooses one mode to cover while ignoring others.</p>
<section id="mathematical-overview" class="level4" data-number="6.2.2.1">
<h4 data-number="6.2.2.1" class="anchored" data-anchor-id="mathematical-overview"><span class="header-section-number">6.2.2.1</span> Mathematical Overview</h4>
<p>The reverse KL is defined as <span class="math display">\[
\mathrm{KL}(q\,\|\,p) = \int q(x) \log \frac{q(x)}{p(x)}\,dx,
\]</span> so the expectation is taken under the model distribution <span class="math inline">\(q\)</span>. If <span class="math inline">\(q(x)\)</span> places mass where <span class="math inline">\(p(x)\)</span> is negligible, the logarithm term explodes and strongly penalizes those regions. Conversely, areas where <span class="math inline">\(p\)</span> has mass but <span class="math inline">\(q\)</span> does not contribute nothing, which is why the optimizer can collapse onto a single mode when matching multimodal targets.</p>
<p>Let us compare the two on a mixture of Gaussians.</p>
<div id="9c983794" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward vs. reverse KL on a bimodal target</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>mixture_target <span class="op">=</span> TARGETS[<span class="st">"gaussian_mixture"</span>]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>component_means <span class="op">=</span> mixture_target.metadata.get(<span class="st">"means"</span>, (<span class="op">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>component_stds <span class="op">=</span> mixture_target.metadata.get(<span class="st">"stds"</span>, (<span class="fl">0.6</span>, <span class="fl">0.6</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>component_weights <span class="op">=</span> mixture_target.metadata.get(<span class="st">"weights"</span>, (<span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    mixture_pdf <span class="op">=</span> mixture_target.pdf(GRID_X).cpu().numpy()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    component_curves <span class="op">=</span> []</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> mean, std, weight <span class="kw">in</span> <span class="bu">zip</span>(component_means, component_stds, component_weights):</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        component_pdf <span class="op">=</span> weight <span class="op">*</span> gaussian_pdf_torch(GRID_X, mean, std)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        component_curves.append((mean, weight, component_pdf.cpu().numpy()))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>fig_density, ax_density <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>ax_density.plot(grid_np, mixture_pdf, label<span class="op">=</span><span class="st">"Target mixture"</span>, linewidth<span class="op">=</span><span class="dv">3</span>, color<span class="op">=</span><span class="st">"tab:blue"</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mean, weight, comp_pdf <span class="kw">in</span> component_curves:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    ax_density.plot(</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        grid_np,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        comp_pdf,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        linestyle<span class="op">=</span><span class="st">"--"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="ss">f"Component μ=</span><span class="sc">{</span>mean<span class="sc">:.1f}</span><span class="ss">, w=</span><span class="sc">{</span>weight<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>ax_density.set_title(<span class="st">"Gaussian Mixture Target and Component Contributions"</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>ax_density.set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>ax_density.set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>ax_density.legend()</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>fig_density.tight_layout()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>mu_values <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">4.0</span>, <span class="fl">4.0</span>, <span class="dv">161</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>forward_metrics_mix, forward_grads_mix <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    mu_values,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> mu: forward_kl(mu, mixture_target, model_std<span class="op">=</span><span class="fl">1.0</span>),</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>reverse_metrics_mix, reverse_grads_mix <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    mu_values,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> mu: reverse_kl(mu, mixture_target, model_std<span class="op">=</span><span class="fl">1.0</span>),</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(mu_values, forward_metrics_mix, label<span class="op">=</span><span class="st">"Forward KL"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(mu_values, reverse_metrics_mix, label<span class="op">=</span><span class="st">"Reverse KL"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"KL Divergences vs. μ (Mixture Target)"</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Divergence"</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(mu_values, forward_grads_mix, label<span class="op">=</span><span class="st">"Forward KL gradient"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(mu_values, reverse_grads_mix, label<span class="op">=</span><span class="st">"Reverse KL gradient"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Gradient signals"</span>)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Mode-Covering vs. Mode-Seeking Behaviour"</span>)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection: Mode Covering vs.&nbsp;Mode Seeking
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Why does the forward KL gradient stay non-zero even between the two modes?<br>
</li>
<li>Identify the regions where the reverse KL gradient vanishes. How does that explain a model that only tracks one mode?</li>
</ul>
</div>
</div>
</section>
</section>
</section>
<section id="jensenshannon-divergence" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="jensenshannon-divergence"><span class="header-section-number">6.3</span> Jensen–Shannon Divergence</h2>
<p>The Jensen–Shannon (JS) divergence symmetrizes KL by averaging the two distributions: <span class="math inline">\(m(x) = \tfrac{1}{2}(p(x)+q(x))\)</span>. It stays finite even when supports do not match and is bounded between 0 and <span class="math inline">\(\log 2\)</span>.</p>
<section id="mathematical-formulation" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="mathematical-formulation"><span class="header-section-number">6.3.1</span> Mathematical Formulation</h3>
<p><span class="math display">\[
\mathrm{JS}(p, q) = \tfrac{1}{2} \mathrm{KL}(p\,\|\,m) + \tfrac{1}{2} \mathrm{KL}(q\,\|\,m), \quad m = \tfrac{1}{2}(p + q).
\]</span> We will compute JS numerically on the same grid. Autograd gives us gradients through the logarithms as long as we keep everything in PyTorch tensors.</p>
<div id="03595027" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jensen_shannon(mu: torch.Tensor, target: DistributionSpec, model_std: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    p_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    q_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu, model_std)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    m_pdf <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (p_pdf <span class="op">+</span> q_pdf)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    term_p <span class="op">=</span> p_pdf <span class="op">*</span> torch.log((p_pdf <span class="op">+</span> EPS) <span class="op">/</span> (m_pdf <span class="op">+</span> EPS))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    term_q <span class="op">=</span> q_pdf <span class="op">*</span> torch.log((q_pdf <span class="op">+</span> EPS) <span class="op">/</span> (m_pdf <span class="op">+</span> EPS))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> torch.trapz(term_p, GRID_X) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> torch.trapz(term_q, GRID_X)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="30a9375b" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># JS divergence vs. μ for Gaussian target compared to forward KL</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>mu_values <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">15.0</span>, <span class="fl">15.0</span>, <span class="dv">121</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>js_metrics, js_grads <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    mu_values,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> mu: jensen_shannon(mu, TARGETS[<span class="st">"gaussian"</span>], model_std<span class="op">=</span><span class="fl">1.0</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(mu_values, forward_metrics, label<span class="op">=</span><span class="st">"Forward KL"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(mu_values, js_metrics, label<span class="op">=</span><span class="st">"JS"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Forward KL vs. JS"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Divergence"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(mu_values, forward_grads, label<span class="op">=</span><span class="st">"Forward KL gradient"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(mu_values, js_grads, label<span class="op">=</span><span class="st">"JS gradient"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Gradient Comparison"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection: Bounded Divergence, Softer Gradients
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>JS approaches <span class="math inline">\(\log 2\)</span> when the two distributions barely overlap. Where in the plot does that happen?<br>
</li>
<li>Compare the slope near <span class="math inline">\(\mu=0\)</span> for JS and forward KL. What do you notice?</li>
<li>What happens when the distributions move far away from each other?</li>
</ul>
</div>
</div>
<div id="7c7170fd" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive JS explorer</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> widgets <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    maybe_display(<span class="va">None</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    js_target_dropdown <span class="op">=</span> widgets.Dropdown(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>[(spec.name, key) <span class="cf">for</span> key, spec <span class="kw">in</span> TARGETS.items()],</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Target"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        style<span class="op">=</span>{<span class="st">"description_width"</span>: <span class="st">"initial"</span>},</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    js_mu_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">0.0</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">4.0</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">4.0</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"μ"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    js_std_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">1.0</span>, <span class="bu">min</span><span class="op">=</span><span class="fl">0.5</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">2.5</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"σ_q"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    js_output <span class="op">=</span> widgets.Output()</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _update_js(<span class="op">*</span>_):</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> js_output:</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>            js_output.clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> TARGETS[js_target_dropdown.value]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            mu_val <span class="op">=</span> torch.tensor(js_mu_slider.value, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device, requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>            std_val <span class="op">=</span> <span class="bu">float</span>(js_std_slider.value)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>            js_val <span class="op">=</span> jensen_shannon(mu_val, target, model_std<span class="op">=</span>std_val)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            grad <span class="op">=</span> torch.autograd.grad(js_val, mu_val)[<span class="dv">0</span>].detach().cpu().item()</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            target_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            model_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, js_mu_slider.value, std_val)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            mu_values <span class="op">=</span> np.linspace(js_mu_slider.<span class="bu">min</span>, js_mu_slider.<span class="bu">max</span>, <span class="dv">181</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>            metrics_curve, grads_curve <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                mu_values,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> mu: jensen_shannon(mu, target, model_std<span class="op">=</span>std_val),</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            target_np <span class="op">=</span> target_pdf.cpu().numpy()</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            model_np <span class="op">=</span> model_pdf.cpu().numpy()</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>            fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, target_np, label<span class="op">=</span>target.name, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, model_np, label<span class="op">=</span><span class="ss">f"Model μ=</span><span class="sc">{</span>js_mu_slider<span class="sc">.</span>value<span class="sc">:.1f}</span><span class="ss">, σ=</span><span class="sc">{</span>std_val<span class="sc">:.1f}</span><span class="ss">"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_title(<span class="st">"Density comparison"</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].legend()</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].plot(mu_values, metrics_curve, color<span class="op">=</span><span class="st">"tab:blue"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].axvline(js_mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].scatter([js_mu_slider.value], [js_val.detach().cpu().item()], color<span class="op">=</span><span class="st">"tab:blue"</span>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_title(<span class="st">"JS divergence vs. μ"</span>)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_ylabel(<span class="st">"JS divergence"</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].plot(mu_values, grads_curve, color<span class="op">=</span><span class="st">"tab:red"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axvline(js_mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].scatter([js_mu_slider.value], [grad], color<span class="op">=</span><span class="st">"tab:red"</span>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_title(<span class="st">"Gradient d(JS)/dμ"</span>)</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>            fig.suptitle(</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"JS = </span><span class="sc">{</span>js_val<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss"> | Gradient = </span><span class="sc">{</span>grad<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">14</span>,</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            fig.tight_layout()</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> control <span class="kw">in</span> (js_target_dropdown, js_mu_slider, js_std_slider):</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        control.observe(_update_js, names<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    _update_js()</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    maybe_display(widgets.VBox([widgets.HTML(<span class="st">"&lt;h4&gt;Interactive JS Explorer&lt;/h4&gt;"</span>), js_target_dropdown, js_mu_slider, js_std_slider, js_output]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8e2758ab69f34321accd71ea938f758e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
</section>
<section id="maximum-mean-discrepancy-mmd" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="maximum-mean-discrepancy-mmd"><span class="header-section-number">6.4</span> Maximum Mean Discrepancy (MMD)</h2>
<p>MMD measures the distance between mean embeddings of distributions in a reproducing kernel Hilbert space (RKHS). With a kernel <span class="math inline">\(k\)</span>, <span class="math display">\[
\mathrm{MMD}^2(p, q) = \mathbb{E}_{x, x' \sim p}[k(x, x')] - 2\, \mathbb{E}_{x \sim p, y \sim q}[k(x, y)] + \mathbb{E}_{y, y' \sim q}[k(y, y')].
\]</span> We will use the radial basis function (RBF) kernel <span class="math display">\[
k_\sigma(x, y) = \exp\!\left(-\tfrac{(x - y)^2}{2\sigma_k^2}\right),
\]</span> which assigns high similarity when two samples are closer than the bandwidth <span class="math inline">\(\sigma_k\)</span> and decays smoothly otherwise. A small <span class="math inline">\(\sigma_k\)</span> emphasises very local discrepancies—only nearby points contribute—so MMD becomes sensitive to fine-grained differences but can miss global shifts. A large <span class="math inline">\(\sigma_k\)</span> blurs the notion of neighbourhood, making the kernel respond to broader trends while down-weighting local wiggles. Balancing <span class="math inline">\(\sigma_k\)</span> therefore tunes whether we care more about microstructure or coarse alignment between <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span>.</p>
<div id="2f607c85" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shared noise tensors for deterministic MMD estimates</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>BASE_NOISE_NORMAL <span class="op">=</span> torch.randn(<span class="dv">4096</span>, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>BASE_NOISE_UNIFORM <span class="op">=</span> torch.linspace(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="dv">4096</span>, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_with_matching_noise(spec: DistributionSpec, sample_count: <span class="bu">int</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"Uniform"</span> <span class="kw">in</span> spec.name:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        base <span class="op">=</span> BASE_NOISE_UNIFORM[:sample_count]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        base <span class="op">=</span> BASE_NOISE_NORMAL[:sample_count]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> spec.sampler(sample_count, base)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rbf_kernel(x: torch.Tensor, y: torch.Tensor, bandwidth: <span class="bu">float</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    bw <span class="op">=</span> torch.as_tensor(bandwidth, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> x[:, <span class="va">None</span>] <span class="op">-</span> y[<span class="va">None</span>, :]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.exp(<span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> diff.<span class="bu">pow</span>(<span class="dv">2</span>) <span class="op">/</span> (bw <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> EPS))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maximum_mean_discrepancy(</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    mu: torch.Tensor,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    target: DistributionSpec,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    model_std: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    bandwidth: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    sample_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">512</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    samples_p <span class="op">=</span> sample_with_matching_noise(target, sample_count)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    base_gauss <span class="op">=</span> BASE_NOISE_NORMAL[:sample_count]</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    samples_q <span class="op">=</span> mu <span class="op">+</span> model_std <span class="op">*</span> base_gauss</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    xx <span class="op">=</span> rbf_kernel(samples_p, samples_p, bandwidth)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    yy <span class="op">=</span> rbf_kernel(samples_q, samples_q, bandwidth)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    xy <span class="op">=</span> rbf_kernel(samples_p, samples_q, bandwidth)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    xx <span class="op">=</span> xx <span class="op">-</span> torch.diag(torch.diag(xx))</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    yy <span class="op">=</span> yy <span class="op">-</span> torch.diag(torch.diag(yy))</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> sample_count</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    mmd2 <span class="op">=</span> xx.<span class="bu">sum</span>() <span class="op">/</span> (n <span class="op">*</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">+</span> EPS) <span class="op">-</span> <span class="fl">2.0</span> <span class="op">*</span> xy.mean() <span class="op">+</span> yy.<span class="bu">sum</span>() <span class="op">/</span> (n <span class="op">*</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">+</span> EPS)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.sqrt(torch.clamp(mmd2, <span class="bu">min</span><span class="op">=</span><span class="fl">0.0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="049b5ad1" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MMD vs. μ for different kernel bandwidths</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>mu_values <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">15.0</span>, <span class="fl">15.0</span>, <span class="dv">121</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>bandwidths <span class="op">=</span> [<span class="fl">0.3</span>, <span class="fl">1.0</span>, <span class="fl">2.5</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bw <span class="kw">in</span> bandwidths:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    metrics, grads <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        mu_values,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> mu, bw<span class="op">=</span>bw: maximum_mean_discrepancy(mu, TARGETS[<span class="st">"gaussian"</span>], model_std<span class="op">=</span><span class="fl">1.0</span>, bandwidth<span class="op">=</span>bw),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(mu_values, metrics, label<span class="op">=</span><span class="ss">f"σ_k=</span><span class="sc">{</span>bw<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(mu_values, grads, label<span class="op">=</span><span class="ss">f"σ_k=</span><span class="sc">{</span>bw<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"MMD vs. μ (Gaussian target)"</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"MMD"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"MMD gradient vs. μ"</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Experiment: Effect of MMD Kernel Bandwidth
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Which bandwidth reacts most strongly to small shifts in <span class="math inline">\(\mu\)</span>?<br>
</li>
<li>Observe how the gradient flattens for large <span class="math inline">\(\sigma_k\)</span>. When might that be desirable?<br>
</li>
<li>How would you select <span class="math inline">\(\sigma_k\)</span> automatically in a learning system?</li>
</ul>
</div>
</div>
<div id="2eab7128" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive MMD explorer</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> widgets <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    maybe_display(<span class="va">None</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    mmd_target_dropdown <span class="op">=</span> widgets.Dropdown(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>[(spec.name, key) <span class="cf">for</span> key, spec <span class="kw">in</span> TARGETS.items()],</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Target"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        style<span class="op">=</span>{<span class="st">"description_width"</span>: <span class="st">"initial"</span>},</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    mmd_mu_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">0.0</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">15.0</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">15.0</span>, step<span class="op">=</span><span class="fl">0.5</span>, description<span class="op">=</span><span class="st">"μ"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    mmd_std_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">1.0</span>, <span class="bu">min</span><span class="op">=</span><span class="fl">0.5</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">2.5</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"σ_q"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    mmd_bw_slider <span class="op">=</span> widgets.FloatLogSlider(value<span class="op">=</span><span class="fl">1.0</span>, base<span class="op">=</span><span class="dv">10</span>, <span class="bu">min</span><span class="op">=-</span><span class="dv">1</span>, <span class="bu">max</span><span class="op">=</span><span class="dv">1</span>, step<span class="op">=</span><span class="fl">0.05</span>, description<span class="op">=</span><span class="st">"σ_k"</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    mmd_output <span class="op">=</span> widgets.Output()</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _update_mmd(<span class="op">*</span>_):</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mmd_output:</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>            mmd_output.clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> TARGETS[mmd_target_dropdown.value]</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>            mu_val <span class="op">=</span> torch.tensor(mmd_mu_slider.value, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device, requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>            std_val <span class="op">=</span> <span class="bu">float</span>(mmd_std_slider.value)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            bw_val <span class="op">=</span> <span class="bu">float</span>(mmd_bw_slider.value)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            mmd_val <span class="op">=</span> maximum_mean_discrepancy(mu_val, target, model_std<span class="op">=</span>std_val, bandwidth<span class="op">=</span>bw_val)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            grad <span class="op">=</span> torch.autograd.grad(mmd_val, mu_val)[<span class="dv">0</span>].detach().cpu().item()</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>            mu_values <span class="op">=</span> np.linspace(mmd_mu_slider.<span class="bu">min</span>, mmd_mu_slider.<span class="bu">max</span>, <span class="dv">181</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>            metrics_curve, grads_curve <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>                mu_values,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> mu: maximum_mean_discrepancy(mu, target, model_std<span class="op">=</span>std_val, bandwidth<span class="op">=</span>bw_val),</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>            target_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>            model_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, mmd_mu_slider.value, std_val)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>            grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>            target_np <span class="op">=</span> target_pdf.cpu().numpy()</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>            model_np <span class="op">=</span> model_pdf.cpu().numpy()</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>            fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, target_np, label<span class="op">=</span>target.name, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, model_np, label<span class="op">=</span><span class="ss">f"Model μ=</span><span class="sc">{</span>mmd_mu_slider<span class="sc">.</span>value<span class="sc">:.1f}</span><span class="ss">, σ=</span><span class="sc">{</span>std_val<span class="sc">:.1f}</span><span class="ss">"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_title(<span class="st">"Density comparison"</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].legend()</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].plot(mu_values, metrics_curve, color<span class="op">=</span><span class="st">"tab:blue"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].axvline(mmd_mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].scatter([mmd_mu_slider.value], [mmd_val.detach().cpu().item()], color<span class="op">=</span><span class="st">"tab:blue"</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_title(<span class="st">"MMD vs. μ"</span>)</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_ylabel(<span class="st">"MMD"</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].plot(mu_values, grads_curve, color<span class="op">=</span><span class="st">"tab:red"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axvline(mmd_mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].scatter([mmd_mu_slider.value], [grad], color<span class="op">=</span><span class="st">"tab:red"</span>)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_title(<span class="st">"Gradient d(MMD)/dμ"</span>)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>            fig.suptitle(</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"MMD = </span><span class="sc">{</span>mmd_val<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss"> | Gradient = </span><span class="sc">{</span>grad<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">14</span>,</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>            fig.tight_layout()</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> control <span class="kw">in</span> (mmd_target_dropdown, mmd_mu_slider, mmd_std_slider, mmd_bw_slider):</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>        control.observe(_update_mmd, names<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    _update_mmd()</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    maybe_display(</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>        widgets.VBox(</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>                widgets.HTML(<span class="st">"&lt;h4&gt;Interactive MMD Explorer&lt;/h4&gt;"</span>),</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>                mmd_target_dropdown,</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>                mmd_mu_slider,</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>                mmd_std_slider,</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>                mmd_bw_slider,</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>                mmd_output,</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0dd1da7f1fff4c3096f1d7d5cabdffd6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="optimal-transport-wasserstein-2-distance" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="optimal-transport-wasserstein-2-distance"><span class="header-section-number">6.5</span> Optimal Transport (Wasserstein-2 Distance)</h2>
<p>Optimal Transport (OT) frames distribution comparison as the problem of moving probability mass from a source distribution <span class="math inline">\(q\)</span> to a target distribution <span class="math inline">\(p\)</span> at minimal cost. Given a ground cost <span class="math inline">\(c(x, y)\)</span> measuring how expensive it is to transport mass from <span class="math inline">\(x\)</span> to <span class="math inline">\(y\)</span>, the quadratic OT problem seeks a coupling <span class="math inline">\(\pi(x, y)\)</span> with marginals <span class="math inline">\(q\)</span> and <span class="math inline">\(p\)</span> that minimises the total transport cost: <span class="math display">\[
W_2^2(p, q) = \inf_{\pi \in \Pi(p, q)} \int_{\mathbb{R}^d \times \mathbb{R}^d} \|x - y\|^2 \, d\pi(x, y),
\]</span> where <span class="math inline">\(\Pi(p, q)\)</span> denotes the set of joint distributions whose marginals are <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span>. This formulation differs from divergence-based distances above (KL, JS, MMD) because it explicitly models <em>where</em> probability mass must move, rather than comparing densities pointwise or via kernel similarities. As a result, OT remains informative even when supports do not overlap: the metric still reflects how far mass must travel to align the distributions.</p>
<p>In one dimension, the optimal coupling sorts both distributions and pairs quantiles. The squared Wasserstein-2 distance simplifies to <span class="math display">\[
W_2^2(p, q) = \int_0^1 \left|F_p^{-1}(u) - F_q^{-1}(u)\right|^2 \, du,
\]</span> with <span class="math inline">\(F^{-1}\)</span> denoting the quantile function. For Gaussians, this has a closed form <span class="math inline">\(W_2^2 = (\mu_p - \mu)^2 + (\sigma_p - \sigma_q)^2\)</span>. We will compute it via quantile functions to keep the numerical pipeline consistent for non-Gaussian targets.</p>
<div id="0a0b9976" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian_quantile(u: torch.Tensor, mean: <span class="bu">float</span>, std: <span class="bu">float</span>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    mean_t <span class="op">=</span> torch.as_tensor(mean, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    std_t <span class="op">=</span> torch.as_tensor(std, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_t <span class="op">+</span> std_t <span class="op">*</span> math.sqrt(<span class="fl">2.0</span>) <span class="op">*</span> torch.erfinv(<span class="fl">2.0</span> <span class="op">*</span> u <span class="op">-</span> <span class="fl">1.0</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wasserstein_2(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    mu: torch.Tensor,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    target: DistributionSpec,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    model_std: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    sample_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1024</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target.name.startswith(<span class="st">"Gaussian"</span>):  <span class="co"># use closed form</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        mu_p <span class="op">=</span> target.metadata.get(<span class="st">"mean"</span>, <span class="fl">0.0</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        sigma_p <span class="op">=</span> target.metadata.get(<span class="st">"std"</span>, <span class="fl">1.0</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        sigma_q <span class="op">=</span> model_std</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        diff_sq <span class="op">=</span> (mu <span class="op">-</span> mu_p) <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> (sigma_q <span class="op">-</span> sigma_p) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.sqrt(torch.clamp(diff_sq, <span class="bu">min</span><span class="op">=</span><span class="fl">0.0</span>))</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Empirical quantile-based estimate for non-Gaussian targets</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> torch.linspace(<span class="fl">0.0</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">/</span> sample_count, <span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">/</span> sample_count, sample_count, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    samples_p <span class="op">=</span> torch.sort(sample_with_matching_noise(target, sample_count))[<span class="dv">0</span>]</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    samples_q <span class="op">=</span> torch.sort(mu <span class="op">+</span> model_std <span class="op">*</span> BASE_NOISE_NORMAL[:sample_count])[<span class="dv">0</span>]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.sqrt(torch.mean((samples_p <span class="op">-</span> samples_q) <span class="op">**</span> <span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="9a650da7" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wasserstein-2 distance vs. μ for Gaussian target</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mu_values <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">15.0</span>, <span class="fl">15.0</span>, <span class="dv">121</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>w2_metrics, w2_grads <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    mu_values,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> mu: wasserstein_2(mu, TARGETS[<span class="st">"gaussian"</span>], model_std<span class="op">=</span><span class="fl">1.0</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>plot_metric_and_gradient(mu_values, w2_metrics, w2_grads, metric_name<span class="op">=</span><span class="st">"W2"</span>, target_desc<span class="op">=</span>TARGETS[<span class="st">"gaussian"</span>].name)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1f5b6b85" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizing the optimal transport map in 1D</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>mu_demo <span class="op">=</span> <span class="fl">2.5</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>sample_count <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> torch.linspace(<span class="fl">0.0</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">/</span> sample_count, <span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">/</span> sample_count, sample_count, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>source_samples <span class="op">=</span> torch.sort(mu_demo <span class="op">+</span> BASE_NOISE_NORMAL[:sample_count])[<span class="dv">0</span>].cpu().numpy()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>target_samples <span class="op">=</span> torch.sort(sample_with_matching_noise(TARGETS[<span class="st">"gaussian"</span>], sample_count))[<span class="dv">0</span>].cpu().numpy()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>ax.scatter(source_samples, np.zeros_like(source_samples), label<span class="op">=</span><span class="st">"Model"</span>, color<span class="op">=</span><span class="st">"tab:orange"</span>, s<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>ax.scatter(target_samples, np.ones_like(target_samples), label<span class="op">=</span><span class="st">"Target"</span>, color<span class="op">=</span><span class="st">"tab:blue"</span>, s<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> xs, xt <span class="kw">in</span> <span class="bu">zip</span>(source_samples, target_samples):</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    ax.plot([xs, xt], [<span class="fl">0.0</span>, <span class="fl">1.0</span>], color<span class="op">=</span><span class="st">"gray"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Optimal Transport Matching for μ = 2.5"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>ax.set_yticks([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels([<span class="st">"Model"</span>, <span class="st">"Target"</span>])</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="distribution_distance_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection: Transport as Matching
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How does the transport map change if you halve the model variance?<br>
</li>
<li>Compare the length of the transport lines with the Wasserstein distance you computed earlier.<br>
</li>
<li>What would happen if the target distribution had gaps (e.g., a mixture)? Sketch the expected matching pattern.</li>
</ul>
</div>
</div>
<div id="71c8df87" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive Wasserstein explorer</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> widgets <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    maybe_display(<span class="va">None</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    w2_target_dropdown <span class="op">=</span> widgets.Dropdown(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>[(spec.name, key) <span class="cf">for</span> key, spec <span class="kw">in</span> TARGETS.items()],</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Target"</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        style<span class="op">=</span>{<span class="st">"description_width"</span>: <span class="st">"initial"</span>},</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    w2_mu_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">0.0</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">15.0</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">15.0</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"μ"</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    w2_std_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">1.0</span>, <span class="bu">min</span><span class="op">=</span><span class="fl">0.5</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">2.5</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"σ_q"</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    w2_output <span class="op">=</span> widgets.Output()</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _update_w2(<span class="op">*</span>_):</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> w2_output:</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>            w2_output.clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> TARGETS[w2_target_dropdown.value]</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>            mu_val <span class="op">=</span> torch.tensor(w2_mu_slider.value, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device, requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>            std_val <span class="op">=</span> <span class="bu">float</span>(w2_std_slider.value)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>            w2_val <span class="op">=</span> wasserstein_2(mu_val, target, model_std<span class="op">=</span>std_val)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>            grad <span class="op">=</span> torch.autograd.grad(w2_val, mu_val)[<span class="dv">0</span>].detach().cpu().item()</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>            mu_values <span class="op">=</span> np.linspace(w2_mu_slider.<span class="bu">min</span>, w2_mu_slider.<span class="bu">max</span>, <span class="dv">181</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>            metrics_curve, grads_curve <span class="op">=</span> evaluate_metric_curve(</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                mu_values,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> mu: wasserstein_2(mu, target, model_std<span class="op">=</span>std_val),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>            target_pdf <span class="op">=</span> get_target_pdf(target)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>            model_pdf <span class="op">=</span> gaussian_pdf_torch(GRID_X, w2_mu_slider.value, std_val)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>            target_np <span class="op">=</span> target_pdf.cpu().numpy()</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            model_np <span class="op">=</span> model_pdf.cpu().numpy()</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, target_np, label<span class="op">=</span>target.name, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(grid_np, model_np, label<span class="op">=</span><span class="ss">f"Model μ=</span><span class="sc">{</span>w2_mu_slider<span class="sc">.</span>value<span class="sc">:.1f}</span><span class="ss">, σ=</span><span class="sc">{</span>std_val<span class="sc">:.1f}</span><span class="ss">"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_title(<span class="st">"Density comparison"</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].legend()</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].plot(mu_values, metrics_curve, color<span class="op">=</span><span class="st">"tab:blue"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].axvline(w2_mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].scatter([w2_mu_slider.value], [w2_val.detach().cpu().item()], color<span class="op">=</span><span class="st">"tab:blue"</span>)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_title(<span class="st">"Wasserstein-2 vs. μ"</span>)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_ylabel(<span class="st">"W2 distance"</span>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].plot(mu_values, grads_curve, color<span class="op">=</span><span class="st">"tab:red"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].axvline(w2_mu_slider.value, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">":"</span>)</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].scatter([w2_mu_slider.value], [grad], color<span class="op">=</span><span class="st">"tab:red"</span>)</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_title(<span class="st">"Gradient d(W2)/dμ"</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_xlabel(<span class="st">"Model mean μ"</span>)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">2</span>].set_ylabel(<span class="st">"Gradient"</span>)</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>            fig.suptitle(</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"W2 = </span><span class="sc">{</span>w2_val<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss"> | Gradient = </span><span class="sc">{</span>grad<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">14</span>,</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>            fig.tight_layout()</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> target.name.startswith(<span class="st">"Gaussian"</span>):</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>                transport_samples <span class="op">=</span> <span class="dv">80</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>                src <span class="op">=</span> torch.sort(mu_val.detach() <span class="op">+</span> std_val <span class="op">*</span> BASE_NOISE_NORMAL[:transport_samples])[<span class="dv">0</span>].cpu().numpy()</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>                tgt <span class="op">=</span> torch.sort(sample_with_matching_noise(target, transport_samples))[<span class="dv">0</span>].cpu().numpy()</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>                fig_map, ax_map <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>                ax_map.scatter(src, np.zeros_like(src), label<span class="op">=</span><span class="st">"Model"</span>, color<span class="op">=</span><span class="st">"tab:orange"</span>, s<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>                ax_map.scatter(tgt, np.ones_like(tgt), label<span class="op">=</span><span class="st">"Target"</span>, color<span class="op">=</span><span class="st">"tab:blue"</span>, s<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> xs, xt <span class="kw">in</span> <span class="bu">zip</span>(src, tgt):</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>                    ax_map.plot([xs, xt], [<span class="fl">0.0</span>, <span class="fl">1.0</span>], color<span class="op">=</span><span class="st">"gray"</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>                ax_map.set_yticks([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>                ax_map.set_yticklabels([<span class="st">"Model"</span>, <span class="st">"Target"</span>])</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>                ax_map.set_title(<span class="st">"Transport plan snapshot"</span>)</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>                ax_map.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>                fig_map.tight_layout()</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>                plt.show()</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> control <span class="kw">in</span> (w2_target_dropdown, w2_mu_slider, w2_std_slider):</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>        control.observe(_update_w2, names<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>    _update_w2()</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>    maybe_display(widgets.VBox([widgets.HTML(<span class="st">"&lt;h4&gt;Interactive Wasserstein Explorer&lt;/h4&gt;"</span>), w2_target_dropdown, w2_mu_slider, w2_std_slider, w2_output]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d782a34e20da4c979826f08b9056f45a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="information-geometry-vs.-optimal-transport" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="information-geometry-vs.-optimal-transport"><span class="header-section-number">6.6</span> Information Geometry vs.&nbsp;Optimal Transport</h2>
<p>Information Geometry treats families of probability distributions as curved manifolds equipped with the Fisher information metric. Intuitively, it asks: <em>how sensitive are likelihoods to infinitesimal parameter changes?</em> The geometry that emerges is tailored to statistical inference—geodesics correspond to paths that keep models maximally informative, and inner products reflect the Cramér–Rao notion of efficiency. This is why information-geometric tools appear in natural gradient descent, variational inference, and sensor placement problems where we care about how much information parameters carry about data.</p>
<p>Because the Fisher–Rao metric lives on the parameter manifold, it is invariant to reparameterisations and emphasises directions where the distribution changes <em>statistically</em> rather than <em>spatially</em>. In contrast, Optimal Transport metrics such as <span class="math inline">\(W_2\)</span> operate directly on the sample space and quantify how far probability mass must move. OT is therefore ideal when spatial structure matters—think of matching shapes, aligning time-series histograms, or enforcing smooth transport maps in PDE-constrained problems.</p>
<p>When would you pick one over the other? - Use Information Geometry when optimizing probabilistic models with latent variables or exponential-family structure, where natural gradients provide preconditioning aligned with likelihood curvature. - Use OT when discrepancies in physical space are key, such as calibrating simulators to sensor data, training generative models that must respect spatial coherence, or comparing distributions with disjoint supports. It is also useful when the target distributions do not have an analytical form but samples are available.</p>
<p>Let us compare the two on Gaussian families and visualize the geodesic paths they induce.</p>
<div id="2eaada0a" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> geomstats.geometry.normal_distribution <span class="im">import</span> NormalDistributions</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> geomstats.learning.frechet_mean <span class="im">import</span> FrechetMean</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    GEOMSTATS_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    GEOMSTATS_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fisher_rao_distance(mu1: <span class="bu">float</span>, sigma1: <span class="bu">float</span>, mu2: <span class="bu">float</span>, sigma2: <span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    term <span class="op">=</span> (sigma1 <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> sigma2 <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> (mu1 <span class="op">-</span> mu2) <span class="op">**</span> <span class="dv">2</span>) <span class="op">/</span> (<span class="fl">2.0</span> <span class="op">*</span> sigma1 <span class="op">*</span> sigma2)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    term <span class="op">=</span> <span class="bu">max</span>(term, <span class="fl">1.0</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> math.sqrt(<span class="fl">2.0</span>) <span class="op">*</span> math.acosh(term)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ot_geodesic(mu1: <span class="bu">float</span>, sigma1: <span class="bu">float</span>, mu2: <span class="bu">float</span>, sigma2: <span class="bu">float</span>, num_points: <span class="bu">int</span> <span class="op">=</span> <span class="dv">50</span>) <span class="op">-&gt;</span> Tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> np.linspace(<span class="fl">0.0</span>, <span class="fl">1.0</span>, num_points)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    mus <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> ts) <span class="op">*</span> mu1 <span class="op">+</span> ts <span class="op">*</span> mu2</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    sigmas <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> ts) <span class="op">*</span> sigma1 <span class="op">+</span> ts <span class="op">*</span> sigma2</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts, mus, sigmas</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fisher_rao_geodesic(mu1: <span class="bu">float</span>, sigma1: <span class="bu">float</span>, mu2: <span class="bu">float</span>, sigma2: <span class="bu">float</span>, num_points: <span class="bu">int</span> <span class="op">=</span> <span class="dv">50</span>) <span class="op">-&gt;</span> Tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> np.linspace(<span class="fl">0.0</span>, <span class="fl">1.0</span>, num_points)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> GEOMSTATS_AVAILABLE:</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>        manifold <span class="op">=</span> NormalDistributions()</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> manifold.geodesic(initial_point<span class="op">=</span>np.array([mu1, sigma1 <span class="op">**</span> <span class="dv">2</span>]), end_point<span class="op">=</span>np.array([mu2, sigma2 <span class="op">**</span> <span class="dv">2</span>]))</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        geodesic_points <span class="op">=</span> np.array([path(t) <span class="cf">for</span> t <span class="kw">in</span> ts])</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        mus <span class="op">=</span> geodesic_points[:, <span class="dv">0</span>]</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        sigmas <span class="op">=</span> np.sqrt(np.<span class="bu">abs</span>(geodesic_points[:, <span class="dv">1</span>]))</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ts, mus, sigmas</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: interpolate in natural parameters (μ/σ, log σ)</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    theta1 <span class="op">=</span> np.array([mu1 <span class="op">/</span> sigma1, math.log(sigma1)])</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    theta2 <span class="op">=</span> np.array([mu2 <span class="op">/</span> sigma2, math.log(sigma2)])</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    thetas <span class="op">=</span> np.outer(<span class="dv">1</span> <span class="op">-</span> ts, theta1) <span class="op">+</span> np.outer(ts, theta2)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    sigmas <span class="op">=</span> np.exp(thetas[:, <span class="dv">1</span>])</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    mus <span class="op">=</span> thetas[:, <span class="dv">0</span>] <span class="op">*</span> sigmas</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts, mus, sigmas</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="9a6ca046" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Show Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare Wasserstein-2 and Fisher-Rao distances/geodesics</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> widgets <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    mu1, sigma1 <span class="op">=</span> <span class="fl">0.0</span>, <span class="fl">1.0</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    mu2, sigma2 <span class="op">=</span> <span class="fl">2.5</span>, <span class="fl">0.5</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    w2_val <span class="op">=</span> wasserstein_2(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        torch.tensor(mu2, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        make_gaussian(mean<span class="op">=</span>mu1, std<span class="op">=</span>sigma1),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        model_std<span class="op">=</span>sigma2,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    ).item()</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    fr_val <span class="op">=</span> fisher_rao_distance(mu1, sigma1, mu2, sigma2)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"W2(p, q) = </span><span class="sc">{</span>w2_val<span class="sc">:.3f}</span><span class="ch">\n</span><span class="ss">Fisher–Rao(p, q) = </span><span class="sc">{</span>fr_val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    ts_ot, mus_ot, sigmas_ot <span class="op">=</span> ot_geodesic(mu1, sigma1, mu2, sigma2, num_points<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    ts_fr, mus_fr, sigmas_fr <span class="op">=</span> fisher_rao_geodesic(mu1, sigma1, mu2, sigma2, num_points<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(ts_ot, mus_ot, label<span class="op">=</span><span class="st">"OT geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(ts_fr, mus_fr, label<span class="op">=</span><span class="st">"Fisher–Rao geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">"t"</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Mean μ(t)"</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">"Mean evolution"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].legend()</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(ts_ot, sigmas_ot, label<span class="op">=</span><span class="st">"OT geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(ts_fr, sigmas_fr, label<span class="op">=</span><span class="st">"Fisher–Rao geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">"t"</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Std σ(t)"</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">"Scale evolution"</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].legend()</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    fig.tight_layout()</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    sample_ts <span class="op">=</span> np.linspace(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="dv">6</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> plt.cm.viridis(sample_ts)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    fig_interp, interp_axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t_val, color <span class="kw">in</span> <span class="bu">zip</span>(sample_ts, colors):</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        mu_t_ot <span class="op">=</span> np.interp(t_val, ts_ot, mus_ot)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        sigma_t_ot <span class="op">=</span> np.interp(t_val, ts_ot, sigmas_ot)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        pdf_ot <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu_t_ot, sigma_t_ot).cpu().numpy()</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        interp_axes[<span class="dv">0</span>].plot(grid_np, pdf_ot, color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"t=</span><span class="sc">{</span>t_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">0</span>].set_title(<span class="st">"OT interpolation (W2 geodesic)"</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">0</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">0</span>].legend(loc<span class="op">=</span><span class="st">"upper right"</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t_val, color <span class="kw">in</span> <span class="bu">zip</span>(sample_ts, colors):</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>        mu_t_fr <span class="op">=</span> np.interp(t_val, ts_fr, mus_fr)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        sigma_t_fr <span class="op">=</span> np.interp(t_val, ts_fr, sigmas_fr)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        pdf_fr <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu_t_fr, sigma_t_fr).cpu().numpy()</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>        interp_axes[<span class="dv">1</span>].plot(grid_np, pdf_fr, color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"t=</span><span class="sc">{</span>t_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">1</span>].set_title(<span class="st">"Information-geometry interpolation (Fisher–Rao)"</span>)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">1</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    interp_axes[<span class="dv">1</span>].legend(loc<span class="op">=</span><span class="st">"upper right"</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    fig_interp.tight_layout()</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    ig_mu1_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">0.0</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">4.0</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">4.0</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"μ₁"</span>)</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    ig_sigma1_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">1.0</span>, <span class="bu">min</span><span class="op">=</span><span class="fl">0.2</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">3.0</span>, step<span class="op">=</span><span class="fl">0.05</span>, description<span class="op">=</span><span class="st">"σ₁"</span>)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    ig_mu2_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">2.5</span>, <span class="bu">min</span><span class="op">=-</span><span class="fl">4.0</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">4.0</span>, step<span class="op">=</span><span class="fl">0.1</span>, description<span class="op">=</span><span class="st">"μ₂"</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    ig_sigma2_slider <span class="op">=</span> widgets.FloatSlider(value<span class="op">=</span><span class="fl">0.5</span>, <span class="bu">min</span><span class="op">=</span><span class="fl">0.2</span>, <span class="bu">max</span><span class="op">=</span><span class="fl">3.0</span>, step<span class="op">=</span><span class="fl">0.05</span>, description<span class="op">=</span><span class="st">"σ₂"</span>)</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    ig_output <span class="op">=</span> widgets.Output()</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _update_geodesic(<span class="op">*</span>_):</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> ig_output:</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>            ig_output.clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            mu1 <span class="op">=</span> <span class="bu">float</span>(ig_mu1_slider.value)</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            sigma1 <span class="op">=</span> <span class="bu">float</span>(ig_sigma1_slider.value)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>            mu2 <span class="op">=</span> <span class="bu">float</span>(ig_mu2_slider.value)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>            sigma2 <span class="op">=</span> <span class="bu">float</span>(ig_sigma2_slider.value)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>            w2_val <span class="op">=</span> wasserstein_2(</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>                torch.tensor(mu2, dtype<span class="op">=</span>DEFAULT_DTYPE, device<span class="op">=</span>device),</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>                make_gaussian(mean<span class="op">=</span>mu1, std<span class="op">=</span>sigma1),</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>                model_std<span class="op">=</span>sigma2,</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>            ).item()</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>            fr_val <span class="op">=</span> fisher_rao_distance(mu1, sigma1, mu2, sigma2)</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"W2(p, q) = </span><span class="sc">{</span>w2_val<span class="sc">:.3f}</span><span class="ch">\n</span><span class="ss">Fisher–Rao(p, q) = </span><span class="sc">{</span>fr_val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>            ts_ot, mus_ot, sigmas_ot <span class="op">=</span> ot_geodesic(mu1, sigma1, mu2, sigma2, num_points<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>            ts_fr, mus_fr, sigmas_fr <span class="op">=</span> fisher_rao_geodesic(mu1, sigma1, mu2, sigma2, num_points<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>            fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(ts_ot, mus_ot, label<span class="op">=</span><span class="st">"OT geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].plot(ts_fr, mus_fr, label<span class="op">=</span><span class="st">"Fisher–Rao geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_xlabel(<span class="st">"t"</span>)</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Mean μ(t)"</span>)</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].set_title(<span class="st">"Mean evolution"</span>)</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">0</span>].legend()</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].plot(ts_ot, sigmas_ot, label<span class="op">=</span><span class="st">"OT geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].plot(ts_fr, sigmas_fr, label<span class="op">=</span><span class="st">"Fisher–Rao geodesic"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_xlabel(<span class="st">"t"</span>)</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Std σ(t)"</span>)</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].set_title(<span class="st">"Scale evolution"</span>)</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].legend()</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>            fig.tight_layout()</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>            sample_ts <span class="op">=</span> np.linspace(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="dv">6</span>)</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>            colors <span class="op">=</span> plt.cm.viridis(sample_ts)</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>            grid_np <span class="op">=</span> GRID_X.cpu().numpy()</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>            fig_interp, interp_axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t_val, color <span class="kw">in</span> <span class="bu">zip</span>(sample_ts, colors):</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>                mu_t_ot <span class="op">=</span> np.interp(t_val, ts_ot, mus_ot)</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>                sigma_t_ot <span class="op">=</span> np.interp(t_val, ts_ot, sigmas_ot)</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>                pdf_ot <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu_t_ot, sigma_t_ot).cpu().numpy()</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>                interp_axes[<span class="dv">0</span>].plot(grid_np, pdf_ot, color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"t=</span><span class="sc">{</span>t_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">0</span>].set_title(<span class="st">"OT interpolation (W2 geodesic)"</span>)</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">0</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">0</span>].legend(loc<span class="op">=</span><span class="st">"upper right"</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t_val, color <span class="kw">in</span> <span class="bu">zip</span>(sample_ts, colors):</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>                mu_t_fr <span class="op">=</span> np.interp(t_val, ts_fr, mus_fr)</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>                sigma_t_fr <span class="op">=</span> np.interp(t_val, ts_fr, sigmas_fr)</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>                pdf_fr <span class="op">=</span> gaussian_pdf_torch(GRID_X, mu_t_fr, sigma_t_fr).cpu().numpy()</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>                interp_axes[<span class="dv">1</span>].plot(grid_np, pdf_fr, color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"t=</span><span class="sc">{</span>t_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">1</span>].set_title(<span class="st">"Information-geometry interpolation (Fisher–Rao)"</span>)</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">1</span>].set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>            interp_axes[<span class="dv">1</span>].legend(loc<span class="op">=</span><span class="st">"upper right"</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>            fig_interp.tight_layout()</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> control <span class="kw">in</span> (ig_mu1_slider, ig_sigma1_slider, ig_mu2_slider, ig_sigma2_slider):</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>        control.observe(_update_geodesic, names<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>    _update_geodesic()</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>    controls <span class="op">=</span> widgets.HBox([widgets.VBox([ig_mu1_slider, ig_sigma1_slider]), widgets.VBox([ig_mu2_slider, ig_sigma2_slider])])</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>    maybe_display(widgets.VBox([widgets.HTML(<span class="st">"&lt;h4&gt;IG vs. OT Geodesic Explorer&lt;/h4&gt;"</span>), controls, ig_output]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d04e239a8a8b4aae9d52585cab4fb821","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Experiment: Comparison of OT versus Fisher–Rao
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>OT interpolates linearly in the mean; Fisher–Rao bends the path. How might that influence optimization trajectories?<br>
</li>
<li>Which metric is more sensitive to changes in variance vs.&nbsp;mean in this example?<br>
</li>
<li>If you needed to regularize a generative model toward a reference Gaussian, which geometry would you prefer and why?</li>
</ul>
</div>
</div>
</section>
<section id="wrap-up" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="wrap-up"><span class="header-section-number">6.7</span> Wrap-Up</h2>
<p>We inspected five prominent distribution distances, paying attention to the gradients they induce for a simple Gaussian parameter. Key takeaways: - KL divergences emphasize support mismatch and can be asymmetric in how they penalize missing mass. - JS divergence softens gradients and stays bounded, making it attractive for adversarial training. - MMD exposes the role of kernel bandwidth in shaping sensitivity to local vs.&nbsp;global structure. - Wasserstein distance reasons about mass transport and yields interpretable gradient flows. - Fisher–Rao geometry offers a complementary, information-theoretic notion of proximity with different geodesics.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../part1/taking_derivatives.html" class="pagination-link" aria-label="Taking Derivatives with Automatic Differentiation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Taking Derivatives with Automatic Differentiation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../part2/part2.html" class="pagination-link" aria-label="Model-Specific Approaches">
        <span class="nav-page-text">Model-Specific Approaches</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Machine Learning for Mechanical Engineers © 2025 by <a href="./index.qmd#sec-contributors">Mark Fuge and IDEAL Lab Contributors</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>